var __extends=this&&this.__extends||function(){var extendStatics=function(d,b){extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(Object.prototype.hasOwnProperty.call(b,p))d[p]=b[p]};return extendStatics(d,b)};return function(d,b){if(typeof b!=="function"&&b!==null)throw new TypeError("Class extends value "+String(b)+" is not a constructor or null");extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var PredictiveSearch=function(_super){__extends(PredictiveSearch,_super);function PredictiveSearch(){var _this=_super.call(this)||this;_this.cachedResults={};_this.predictiveSearchResults=_this.querySelector("[data-predictive-search]");_this.allPredictiveSearchInstances=document.querySelectorAll("predictive-search");_this.isOpen=false;_this.abortController=new AbortController;_this.searchTerm="";_this.setupEventListeners();return _this}PredictiveSearch.prototype.setupEventListeners=function(){this.input.form.addEventListener("submit",this.onFormSubmit.bind(this));this.input.addEventListener("focus",this.onFocus.bind(this));this.addEventListener("focusout",this.onFocusOut.bind(this));this.addEventListener("keyup",this.onKeyup.bind(this));this.addEventListener("keydown",this.onKeydown.bind(this))};PredictiveSearch.prototype.getQuery=function(){return this.input.value.trim()};PredictiveSearch.prototype.onChange=function(){var _a;_super.prototype.onChange.call(this);var newSearchTerm=this.getQuery();if(!this.searchTerm||!newSearchTerm.startsWith(this.searchTerm)){(_a=this.querySelector("#predictive-search-results-groups-wrapper"))===null||_a===void 0?void 0:_a.remove()}this.updateSearchForTerm(this.searchTerm,newSearchTerm);this.searchTerm=newSearchTerm;if(!this.searchTerm.length){this.close(true);return}this.getSearchResults(this.searchTerm)};PredictiveSearch.prototype.onFormSubmit=function(event){if(!this.getQuery().length||this.querySelector('[aria-selected="true"] a'))event.preventDefault()};PredictiveSearch.prototype.onFormReset=function(event){_super.prototype.onFormReset.call(this,event);if(_super.prototype.shouldResetForm.call(this)){this.searchTerm="";this.abortController.abort();this.abortController=new AbortController;this.closeResults(true)}};PredictiveSearch.prototype.onFocus=function(){var currentSearchTerm=this.getQuery();if(!currentSearchTerm.length)return;if(this.searchTerm!==currentSearchTerm){this.onChange()}else if(this.getAttribute("results")==="true"){this.open()}else{this.getSearchResults(this.searchTerm)}};PredictiveSearch.prototype.onFocusOut=function(){var _this=this;setTimeout(function(){if(!_this.contains(document.activeElement))_this.close()})};PredictiveSearch.prototype.onKeyup=function(event){if(!this.getQuery().length)this.close(true);event.preventDefault();switch(event.code){case"ArrowUp":this.switchOption("up");break;case"ArrowDown":this.switchOption("down");break;case"Enter":this.selectOption();break}};PredictiveSearch.prototype.onKeydown=function(event){if(event.code==="ArrowUp"||event.code==="ArrowDown"){event.preventDefault()}};PredictiveSearch.prototype.updateSearchForTerm=function(previousTerm,newTerm){var searchForTextElement=this.querySelector("[data-predictive-search-search-for-text]");var currentButtonText=searchForTextElement===null||searchForTextElement===void 0?void 0:searchForTextElement.innerText;if(currentButtonText){if(currentButtonText.match(new RegExp(previousTerm,"g")).length>1){return}var newButtonText=currentButtonText.replace(previousTerm,newTerm);searchForTextElement.innerText=newButtonText}};PredictiveSearch.prototype.switchOption=function(direction){if(!this.getAttribute("open"))return;var moveUp=direction==="up";var selectedElement=this.querySelector('[aria-selected="true"]');var allVisibleElements=Array.from(this.querySelectorAll("li, button.predictive-search__item")).filter(function(element){return element.offsetParent!==null});var activeElementIndex=0;if(moveUp&&!selectedElement)return;var selectedElementIndex=-1;var i=0;while(selectedElementIndex===-1&&i<=allVisibleElements.length){if(allVisibleElements[i]===selectedElement){selectedElementIndex=i}i++}this.statusElement.textContent="";if(!moveUp&&selectedElement){activeElementIndex=selectedElementIndex===allVisibleElements.length-1?0:selectedElementIndex+1}else if(moveUp){activeElementIndex=selectedElementIndex===0?allVisibleElements.length-1:selectedElementIndex-1}if(activeElementIndex===selectedElementIndex)return;var activeElement=allVisibleElements[activeElementIndex];activeElement.setAttribute("aria-selected",true);if(selectedElement)selectedElement.setAttribute("aria-selected",false);this.input.setAttribute("aria-activedescendant",activeElement.id)};PredictiveSearch.prototype.selectOption=function(){var selectedOption=this.querySelector('[aria-selected="true"] a, button[aria-selected="true"]');if(selectedOption)selectedOption.click()};PredictiveSearch.prototype.getSearchResults=function(searchTerm){var _this=this;var queryKey=searchTerm.replace(" ","-").toLowerCase();this.setLiveRegionLoadingState();if(this.cachedResults[queryKey]){this.renderSearchResults(this.cachedResults[queryKey]);return}fetch("".concat(routes.predictive_search_url,"?q=").concat(encodeURIComponent(searchTerm),"&section_id=predictive-search"),{signal:this.abortController.signal}).then(function(response){if(!response.ok){var error=new Error(response.status);_this.close();throw error}return response.text()}).then(function(text){var resultsMarkup=(new DOMParser).parseFromString(text,"text/html").querySelector("#shopify-section-predictive-search").innerHTML;_this.allPredictiveSearchInstances.forEach(function(predictiveSearchInstance){predictiveSearchInstance.cachedResults[queryKey]=resultsMarkup});_this.renderSearchResults(resultsMarkup)}).catch(function(error){if((error===null||error===void 0?void 0:error.code)===20){return}_this.close();throw error})};PredictiveSearch.prototype.setLiveRegionLoadingState=function(){this.statusElement=this.statusElement||this.querySelector(".predictive-search-status");this.loadingText=this.loadingText||this.getAttribute("data-loading-text");this.setLiveRegionText(this.loadingText);this.setAttribute("loading",true)};PredictiveSearch.prototype.setLiveRegionText=function(statusText){var _this=this;this.statusElement.setAttribute("aria-hidden","false");this.statusElement.textContent=statusText;setTimeout(function(){_this.statusElement.setAttribute("aria-hidden","true")},1e3)};PredictiveSearch.prototype.renderSearchResults=function(resultsMarkup){this.predictiveSearchResults.innerHTML=resultsMarkup;this.setAttribute("results",true);this.setLiveRegionResults();this.open()};PredictiveSearch.prototype.setLiveRegionResults=function(){this.removeAttribute("loading");this.setLiveRegionText(this.querySelector("[data-predictive-search-live-region-count-value]").textContent)};PredictiveSearch.prototype.getResultsMaxHeight=function(){this.resultsMaxHeight=window.innerHeight-document.querySelector(".section-header").getBoundingClientRect().bottom;return this.resultsMaxHeight};PredictiveSearch.prototype.open=function(){this.predictiveSearchResults.style.maxHeight=this.resultsMaxHeight||"".concat(this.getResultsMaxHeight(),"px");this.setAttribute("open",true);this.input.setAttribute("aria-expanded",true);this.isOpen=true};PredictiveSearch.prototype.close=function(clearSearchTerm){if(clearSearchTerm===void 0){clearSearchTerm=false}this.closeResults(clearSearchTerm);this.isOpen=false};PredictiveSearch.prototype.closeResults=function(clearSearchTerm){if(clearSearchTerm===void 0){clearSearchTerm=false}if(clearSearchTerm){this.input.value="";this.removeAttribute("results")}var selected=this.querySelector('[aria-selected="true"]');if(selected)selected.setAttribute("aria-selected",false);this.input.setAttribute("aria-activedescendant","");this.removeAttribute("loading");this.removeAttribute("open");this.input.setAttribute("aria-expanded",false);this.resultsMaxHeight=false;this.predictiveSearchResults.removeAttribute("style")};return PredictiveSearch}(SearchForm);customElements.define("predictive-search",PredictiveSearch);
